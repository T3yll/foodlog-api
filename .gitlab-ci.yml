# ğŸ§ª Pipeline GitLab - Tests FoodItems + SÃ©curitÃ© & QualitÃ©

stages:
  - quality
  - test

# ========================================
# ğŸ“¦ CACHE DES DÃ‰PENDANCES
# ========================================
cache:
  key: "$CI_COMMIT_REF_SLUG"
  paths:
    - node_modules/

# ========================================
# ğŸ›¡ï¸ SÃ‰CURITÃ‰ & QUALITÃ‰ DE CODE
# ========================================
security-and-quality:
  stage: quality
  image: node:18-alpine
  before_script:
    - npm ci
  script:
    # ğŸ” Audit de sÃ©curitÃ© des dÃ©pendances
    - echo "ğŸ” Audit de sÃ©curitÃ© npm..."
    - npm audit --audit-level moderate
    
    # ğŸ“ VÃ©rification du formatage
    - echo "ğŸ“ VÃ©rification du formatage..."
    - npx prettier --check "src/**/*.ts" "test/**/*.ts" || echo "âš ï¸ Formatage Ã  corriger"
    
    # ğŸ§¹ Linting et qualitÃ© de code
    - echo "ğŸ§¹ Analyse ESLint..."
    - npx eslint "src/**/*.ts" --format json --output-file eslint-report.json || true
    - npx eslint "src/**/*.ts" || echo "âš ï¸ ProblÃ¨mes ESLint dÃ©tectÃ©s"
    
    # ğŸ”’ Recherche de secrets/credentials dans le code
    - echo "ğŸ”’ Recherche de secrets..."
    - |
      echo "Scanning for potential secrets..."
      grep -r -i --exclude-dir=node_modules --exclude="*.log" \
        -E "(password|secret|token|key|api_key|private)" . || echo "âœ… Aucun secret dÃ©tectÃ©"
    
    # ğŸ“Š MÃ©triques de qualitÃ© (complexitÃ©, duplication)
    - echo "ğŸ“Š Analyse de la complexitÃ©..."
    - npx madge --circular src/ || echo "âš ï¸ DÃ©pendances circulaires dÃ©tectÃ©es"
    
    # ğŸ“ˆ Rapport de qualitÃ©
    - echo "ğŸ“ˆ GÃ©nÃ©ration du rapport de qualitÃ©..."
    - |
      echo "=== RAPPORT DE QUALITÃ‰ ==="
      echo "Files analysÃ©s: $(find src -name "*.ts" | wc -l)"
      echo "Tests: $(find src -name "*.spec.ts" | wc -l)"
      echo "Lignes de code: $(find src -name "*.ts" ! -name "*.spec.ts" -exec cat {} \; | wc -l)"
      echo "========================="
      
  artifacts:
    when: always
    reports:
      junit: eslint-report.json
    paths:
      - eslint-report.json
    expire_in: 1 week
  allow_failure: true  # Ne pas bloquer si problÃ¨mes de qualitÃ©
  only:
    - master
    - develop

# ========================================
# ğŸ§ª TESTS FOOD-ITEMS
# ========================================
test-food-items:
  stage: test
  image: node:18-alpine
  services:
    - name: postgres:13
      alias: postgres
  variables:
    # Variables PostgreSQL
    POSTGRES_DB: foodlog_test
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: test_password
    # Variables de l'app
    NODE_ENV: test
    DB_HOST: postgres
    DB_PORT: 5432
    DB_USERNAME: postgres
    DB_PASSWORD: test_password
    DB_NAME: foodlog_test
    JWT_SECRET: test-jwt-secret-for-ci-must-be-32-chars-long
  before_script:
    # Installer PostgreSQL client
    - apk add --no-cache postgresql-client
    # Installer les dÃ©pendances
    - npm ci
    # Attendre PostgreSQL
    - until pg_isready -h postgres -p 5432 -U postgres; do sleep 2; done
    - sleep 3
  script:
    # Lancer uniquement les tests food-items
    - npm run test food-items
  artifacts:
    when: always
    paths:
      - coverage/
    expire_in: 1 week
  only:
    - master
    - develop